{% extends 'base_admin.html.twig' %}

{% block title %}Liste des Commandes{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ asset('css/commandes.css') }}">

    <div class="container mt-5">
        <div class="card shadow-sm rounded-3 border-0">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Liste des Commandes</h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-toggle="dropdown">
                        Filtres <span class="caret"></span>
                    </button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item {{ currentFilter == 'all' ? 'active' : '' }}" 
                           href="{{ path('app_commande') }}">Toutes</a>
                        <a class="dropdown-item {{ currentFilter == 'en attente' ? 'active' : '' }}" 
                           href="{{ path('app_commande_filter', {'status': 'en attente'}) }}">En attente</a>
                        <a class="dropdown-item {{ currentFilter == 'confirmé' ? 'active' : '' }}" 
                           href="{{ path('app_commande_filter', {'status': 'confirmé'}) }}">Confirmées</a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" 
                               id="searchInput" 
                               class="form-control" 
                               placeholder="Rechercher par nom, téléphone ou référence..."
                               autocomplete="off">
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle" id="commandesTable">
                        <thead class="table-light">
                            <tr>
                                <th>#ID</th>
                                <th>Client</th>
                                <th>Téléphone</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commande in commandes %}
                                <tr class="{{ commande.status == 'en attente' ? 'table-warning' : '' }}">
                                    <td>CMD-{{ commande.id_com }}</td>
                                    <td>{{ commande.id.nom }} {{ commande.id.prenom }}</td>
                                    <td>{{ commande.id.tel }}</td>
                                    <td>
                                        {{ commande.date_com|date('d/m/Y') }}
                                        <small class="text-muted d-block">{{ commande.date_com|date('H:i') }}</small>
                                    </td>
                                    <td class="font-weight-bold">{{ commande.montant_total|number_format(2) }} €</td>
                                    <td>
                                        <span class="badge badge-{{ 
                                            commande.status == 'traitée' ? 'success' : 'warning' 
                                        }}">
                                            {{ commande.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ path('app_commande_details', {'id': commande.id_com}) }}" 
                                               class="btn btn-info">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            
                                            {% if commande.status == 'en attente' %}
                                                <a href="{{ path('app_commande_confirm', {'id': commande.id_com}) }}" 
                                                   class="btn btn-success"
                                                   onclick="return confirm('Confirmer cette commande ?')">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-2"></i>
                                        <p class="text-muted">Aucune commande trouvée</p>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if commandes|length > 0 %}
                    <nav aria-label="Pagination">
                        {{ knp_pagination_render(commandes) }}
                    </nav>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function() {
            let searchTimeout;
            
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = $(this).val().trim();
                
                searchTimeout = setTimeout(function() {
                    if (searchTerm.length >= 2 || searchTerm.length === 0) {
                        $.ajax({
                            url: '{{ path('app_commande_search') }}',
                            data: { search: searchTerm },
                            success: function(data) {
                                // Mise à jour du tableau uniquement
                                $('#commandesTable tbody').html($(data).find('tbody').html());
                                
                                // Mise à jour de la pagination si nécessaire
                                const newPagination = $(data).find('.pagination').html();
                                if (newPagination) {
                                    $('nav').html(newPagination);
                                } else {
                                    $('nav').remove();
                                }
                            },
                            error: function() {
                                $('#commandesTable tbody').html(
                                    '<tr><td colspan="7" class="text-center text-danger">Erreur lors de la recherche</td></tr>'
                                );
                            }
                        });
                    }
                }, 300);
            });
        });
    </script>
{% endblock %}