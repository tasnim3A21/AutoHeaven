{% extends 'base_admin.html.twig' %}

{% block title %}Liste des Équipements{% endblock %}

{% block content %}
    <!-- Ancien CSS -->
    <link rel="stylesheet" href="{{ asset('css/equiptable.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <div class="container mt-5">
        <div class="card shadow-sm rounded-3 border-0">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Liste des Équipements</h5>
                <a href="{{ path('app_equipements_create') }}" class="btn btn-primary">+ Add Equipement</a>
            </div>
            
            <div class="card-body">
                <!-- Formulaire de recherche -->
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" 
                               id="searchInput" 
                               class="form-control" 
                               placeholder="Rechercher par nom, marque ou référence..."
                               autocomplete="off">
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tableau -->
                <div class="table-responsive">
                    <table class="table align-middle" id="equipementsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Reference</th>
                                <th>Nom</th>
                                <th>Marque</th>
                                <th>Prix</th>
                                <th>Quantite</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody class="table-border-bottom-0">
                            {% for equipement in equipements %}
                                {% for stock in stocks %}
                                    {% if stock.id.getId() == equipement.id %}
                                        <tr>
                                            <td>{{ equipement.reference }}</td>
                                            <td>{{ equipement.nom }}</td>
                                            <td>{{ equipement.marque }}</td>
                                            <td>{{ stock.prixvente }}</td>
                                            <td>{{ stock.quantite }}</td>
                                           <td>
                                               <a href="{{ path('app_equipements_edit', {'id': equipement.id}) }}" class="btn btn-sm btn-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ path('app_equipements_delete', {'id': equipement.id}) }}" 
                                                      onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cet équipement ?');"
                                                      style="display: inline-block;">
                                                    <input type="hidden" name="_method" value="DELETE">
                                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ equipement.id) }}">
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Êtes-vous sûr de vouloir supprimer cet équipement ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ancien JavaScript de recherche conservé -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

   <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const tableBody = document.querySelector('#equipementsTable tbody');
            const originalTableContent = tableBody.innerHTML;
            let searchTimeout;

            function searchEquipements(searchTerm) {
                if (searchTerm.length === 0) {
                    tableBody.innerHTML = originalTableContent;
                    return;
                }

                fetch(`/equipements/search?search=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun résultat trouvé</td></tr>';
                        } else {
                            let html = '';
                            data.data.forEach(equipement => {
                                html += `
                                    <tr>
                                        <td>${equipement.reference}</td>
                                        <td>${equipement.nom}</td>
                                        <td>${equipement.marque}</td>
                                        <td>${equipement.prix}</td>
                                        <td>${equipement.quantite}</td>
                                        <td>
                                            <a href="/equipements/edit/${equipement.id}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="/equipements/delete/${equipement.id}" 
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet équipement ?');">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                `;
                            });
                            tableBody.innerHTML = html;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erreur lors de la recherche</td></tr>';
                    });
            }

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.trim();
                
                searchTimeout = setTimeout(() => {
                    searchEquipements(searchTerm);
                }, 300);
            });
        });
    </script>
{% endblock %}