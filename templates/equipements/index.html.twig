{% extends 'base_admin.html.twig' %}

{% block title %}Liste des Équipements{% endblock %}

{% block content %}
    <!-- Basic Bootstrap Table -->
    <link rel="stylesheet" href="{{ asset('css/equiptable.css') }}">

    <div class="card shadow-sm rounded-3 border-0">
       <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Liste des Équipements</h5>
            <a href="{{ path('app_equipements_create') }}" class="btn btn-primary">Ajouter un équipement</a>
        </div>
        
        <div class="card-body">
            <!-- Formulaire de recherche -->
            <div class="mb-4">
                <div class="input-group">
                    <input type="text" 
                           id="searchInput" 
                           class="form-control" 
                           placeholder="Rechercher par nom, marque ou référence..."
                           autocomplete="off">
                    <div class="input-group-append">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table align-middle" id="equipementsTable">
                    <thead class="table-light">
                        <tr>
                            <th>Reference</th>
                            <th>Nom</th>
                            <th>Marque</th>
                            <th>Prix</th>
                            <th>Quantite</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                     <tbody class="table-border-bottom-0">
                {% for equipement in equipements %}
                 {% for stock in stocks %}
                   {% if stock.id.getId() == equipement.id %}

                    <tr>
                        <td>{{ equipement.id }}</td>
                        <td>{{ equipement.nom }}</td>
                        <td>{{ equipement.marque }}</td>
                         <td>{{ stock.getPrixvente()}}</td>
                         <td>{{ stock.getQuantite() }}</td>

                        <td>
                                    <a  class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="{{ equipement.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                    </tr>
              {% endif %}
                 {% endfor %}
                 {% endfor %}
            </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for delete confirmation -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Êtes-vous sûr de vouloir supprimer cet équipement ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for delete confirmation (identique à avant) -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <!-- ... contenu identique ... -->
    </div>

    <!-- Modal for delete confirmation -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirmer la suppression</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Êtes-vous sûr de vouloir supprimer cet équipement ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for delete confirmation (identique à avant) -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <!-- ... contenu identique ... -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const tableBody = document.querySelector('#equipementsTable tbody');
            const originalTableContent = tableBody.innerHTML;
            let searchTimeout;

            // Fonction pour charger les résultats de recherche via AJAX
            function searchEquipements(searchTerm) {
                if (searchTerm.length === 0) {
                    // Restaurer le contenu original
                    tableBody.innerHTML = originalTableContent;
                    return;
                }

                fetch(`/equipements/search?search=${encodeURIComponent(searchTerm)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun résultat trouvé</td></tr>';
                        } else {
                            let html = '';
                            data.data.forEach(equipement => {
                                html += `
                                    <tr>
                                        <td>${equipement.reference}</td>
                                        <td>${equipement.nom}</td>
                                        <td>${equipement.marque}</td>
                                        <td>${equipement.prix}</td>
                                        <td>${equipement.quantite}</td>
                                        <td>
                                            <a href="/equipements/edit/${equipement.id}" class="btn btn-sm btn-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-sm btn-danger delete-btn" data-id="${equipement.id}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            tableBody.innerHTML = html;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erreur lors de la recherche</td></tr>';
                    });
            }

            // Recherche dynamique avec debounce
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const searchTerm = this.value.trim();
                
                searchTimeout = setTimeout(() => {
                    searchEquipements(searchTerm);
                }, 300);
            });

            // Gestion de la suppression
            let deleteModal = $('#deleteModal');
            let equipmentToDelete = null;

            // Gérer les clics sur les boutons de suppression (y compris ceux chargés dynamiquement)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-btn')) {
                    equipmentToDelete = e.target.closest('.delete-btn').getAttribute('data-id');
                    deleteModal.modal('show');
                }
            });

            document.getElementById('confirmDelete').addEventListener('click', function() {
                if (equipmentToDelete) {
                    fetch(`/equipements/delete/${equipmentToDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Erreur lors de la suppression: ' + (data.message || ''));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Erreur lors de la suppression');
                    })
                    .finally(() => {
                        deleteModal.modal('hide');
                    });
                }
            });
        });
    </script>
    <!-- Librairies (identique) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{% endblock %}